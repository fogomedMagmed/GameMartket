-- Создание таблицы для хранения контекста чата
CREATE TABLE IF NOT EXISTS `chat_context` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `chat_id` int(11) NOT NULL,
  `context_data` json DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `chat_id` (`chat_id`),
  CONSTRAINT `chat_context_ibfk_1` FOREIGN KEY (`chat_id`) REFERENCES `chats` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Расширение таблицы bot_responses для более сложных ответов
ALTER TABLE `bot_responses` ADD COLUMN `category` varchar(50) DEFAULT 'general' AFTER `keyword`;
ALTER TABLE `bot_responses` ADD COLUMN `patterns` json DEFAULT NULL AFTER `keyword`;
ALTER TABLE `bot_responses` ADD COLUMN `requires_context` tinyint(1) DEFAULT 0 AFTER `response`;
ALTER TABLE `bot_responses` ADD COLUMN `sets_context` json DEFAULT NULL AFTER `requires_context`;

-- Добавление более сложных ответов для бота
INSERT INTO `bot_responses` (`keyword`, `category`, `patterns`, `response`, `requires_context`, `sets_context`) VALUES
('приветствие', 'greeting', '["привет", "здравствуйте", "добрый день", "доброе утро", "добрый вечер", "хай", "хелло"]', 'Здравствуйте! Я умный бот поддержки GameMarket. Чем могу помочь вам сегодня?', 0, '{"last_intent": "greeting"}'),
('как дела', 'smalltalk', '["как дела", "как ты", "как поживаешь"]', 'У меня всё отлично, спасибо! Я готов помочь вам с вопросами по GameMarket. Что вас интересует?', 0, '{"last_intent": "smalltalk"}'),
('благодарность', 'smalltalk', '["спасибо", "благодарю", "спс", "сенкс"]', 'Всегда рад помочь! Если у вас возникнут еще вопросы, обращайтесь.', 0, '{"last_intent": "thanks"}'),
('прощание', 'smalltalk', '["пока", "до свидания", "до встречи", "бай"]', 'До свидания! Был рад помочь. Если возникнут вопросы, возвращайтесь!', 0, '{"last_intent": "goodbye"}'),
('заказ_статус', 'orders', '["статус заказа", "где мой заказ", "когда придет заказ", "отследить заказ"]', 'Чтобы узнать статус вашего заказа, перейдите в раздел "Мои заказы" в личном кабинете. Там вы увидите все ваши заказы и их текущий статус. Если вам нужна помощь с конкретным заказом, укажите его номер, и я предоставлю подробную информацию.', 0, '{"last_intent": "order_status", "awaiting": "order_number"}'),
('заказ_проблема', 'orders', '["проблема с заказом", "заказ не пришел", "неправильный заказ", "отменить заказ"]', 'Мне жаль, что у вас возникли проблемы с заказом. Пожалуйста, опишите проблему подробнее и укажите номер заказа, чтобы я мог помочь вам эффективнее.', 0, '{"last_intent": "order_problem", "awaiting": "order_details"}'),
('оплата_методы', 'payment', '["способы оплаты", "как оплатить", "принимаете ли карты", "платежные системы"]', 'На GameMarket доступны следующие способы оплаты:\n1. Банковские карты Visa, MasterCard, МИР\n2. Электронные кошельки (QIWI, ЮMoney)\n3. Мобильные платежи\n\nВсе платежи защищены и проходят через безопасные шлюзы. Какой способ оплаты вас интересует?', 0, '{"last_intent": "payment_methods"}'),
('оплата_проблема', 'payment', '["проблема с оплатой", "оплата не прошла", "двойное списание", "возврат денег"]', 'Извините за проблемы с оплатой. Пожалуйста, укажите:\n1. Дату и время платежа\n2. Способ оплаты\n3. Сумму\n4. Описание проблемы\n\nЭто поможет нам быстрее разобраться в ситуации.', 0, '{"last_intent": "payment_problem", "awaiting": "payment_details"}'),
('регистрация_как', 'account', '["как зарегистрироваться", "создать аккаунт", "регистрация на сайте"]', 'Для регистрации на GameMarket:\n1. Нажмите кнопку "Регистрация" в верхнем меню\n2. Заполните форму с вашими данными\n3. Подтвердите email\n4. Готово!\n\nПосле регистрации вы сможете покупать и продавать игровые товары. Нужна помощь с чем-то конкретным в процессе регистрации?', 0, '{"last_intent": "registration_how"}'),
('аккаунт_восстановление', 'account', '["забыл пароль", "восстановить пароль", "сбросить пароль", "не могу войти"]', 'Для восстановления доступа к аккаунту:\n1. Нажмите "Забыли пароль?" на странице входа\n2. Введите email, указанный при регистрации\n3. Проверьте почту и следуйте инструкциям\n\nЕсли вы не получили письмо, проверьте папку "Спам" или напишите в поддержку.', 0, '{"last_intent": "account_recovery"}'),
('товар_поиск', 'products', '["как найти товар", "поиск товаров", "фильтры товаров"]', 'Для поиска товаров на GameMarket вы можете:\n1. Использовать строку поиска в верхней части сайта\n2. Просматривать товары по категориям\n3. Применять фильтры (цена, продавец, рейтинг)\n\nЧто именно вы хотите найти? Я могу помочь с конкретными рекомендациями.', 0, '{"last_intent": "product_search", "awaiting": "product_interest"}'),
('товар_продажа', 'products', '["как продать товар", "разместить товар", "стать продавцом"]', 'Чтобы продать товар на GameMarket:\n1. Зарегистрируйтесь как продавец\n2. Перейдите в "Панель продавца"\n3. Нажмите "Добавить товар"\n4. Заполните информацию о товаре и загрузите изображения\n\nВаш товар будет доступен после проверки модераторами. Нужна помощь с конкретным шагом?', 0, '{"last_intent": "product_selling", "awaiting": "selling_question"}'),
('безопасность_покупки', 'security', '["безопасно ли покупать", "защита покупателя", "гарантии", "обман"]', 'GameMarket обеспечивает безопасность сделок:\n1. Все продавцы проходят верификацию\n2. Средства переводятся продавцу только после подтверждения получения товара\n3. Служба поддержки помогает разрешить споры\n4. Система отзывов помогает выбрать надежных продавцов\n\nЕсли у вас есть конкретные опасения, я готов их обсудить.', 0, '{"last_intent": "purchase_security"}'),
('контакты', 'contacts', '["контакты", "связаться", "телефон", "адрес", "email поддержки"]', 'Связаться с GameMarket можно:\n• Email: support@gamemarket.ru\n• Телефон: +7 (999) 123-45-67\n• Форма обратной связи на сайте\n• Этот чат поддержки\n\nСлужба поддержки работает ежедневно с 9:00 до 21:00 по московскому времени.', 0, '{"last_intent": "contacts"}'),
('оператор_вызов', 'operator', '["оператор", "человек", "консультант", "специалист", "поддержка"]', 'Сейчас я подключу вас к оператору поддержки. Пожалуйста, подождите немного. Оператор ответит вам в порядке очереди.', 0, NULL);

